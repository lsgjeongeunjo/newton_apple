<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="post-title">ê²Œì‹œê¸€ ìƒì„¸</title>
    <link rel="stylesheet" href="/style.css"> 
</head>
<body>
    <div id="content-container">
        <h1>ğŸ” ê²Œì‹œê¸€ ìƒì„¸ ë‚´ìš©</h1>
        
        <!-- ê²Œì‹œê¸€ ë°ì´í„° í‘œì‹œ ì˜ì—­ -->
        <div id="post-data" class="post-card">
            <h2 id="detail-title">ì œëª© ë¡œë”© ì¤‘...</h2>
            <p>
                ì‘ì„±ì: <span id="detail-user"></span> | 
                ì‘ì„±ì¼: <span id="detail-date"></span> | 
                ì¡°íšŒìˆ˜: <span id="detail-views"></span>
            </p>
            <hr>
            <div id="detail-content" class="content-box">ë‚´ìš© ë¡œë”© ì¤‘...</div>
            <div id="detail-file"></div>
        </div>
        
        <!-- ë²„íŠ¼ ì˜ì—­ (ë¡œê·¸ì¸ ìƒíƒœ ë° ì‘ì„±ì ì—¬ë¶€ì— ë”°ë¼ ë‹¬ë¼ì§) -->
        <div id="button-area" style="margin-top: 20px;">
            <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            <a href="/list" class="button">ëª©ë¡ìœ¼ë¡œ</a>
        </div>
        
        <!-- ëŒ“ê¸€ ì˜ì—­ -->
        <div id="comment-section" style="margin-top: 40px;">
            <h3>ğŸ’¬ ëŒ“ê¸€</h3>
            <!-- ëŒ“ê¸€ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë¨ -->
            <div id="comment-list">ëŒ“ê¸€ ë¡œë”© ì¤‘...</div>

            <!-- ëŒ“ê¸€ ë“±ë¡ í¼ -->
            <form id="comment-form" style="margin-top: 20px;">
                <input type="hidden" id="post_idx_cmt">
                <textarea id="cmt_content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required style="width: 98%; height: 60px;"></textarea>
                <button type="submit" class="button">ëŒ“ê¸€ ë“±ë¡</button>
            </form>
        </div>
    </div>

    <!-- ---------------------------------------------------- -->
    <!-- JavaScript ë¡œì§ -->
    <!-- ---------------------------------------------------- -->
    <script>
        const contentContainer = document.getElementById('content-container');
        const postData = document.getElementById('post-data');
        const buttonArea = document.getElementById('button-area');
        const commentForm = document.getElementById('comment-form');
        
        // URLì—ì„œ post_idx ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. (ì˜ˆ: /detail?post_idx=10)
        const urlParams = new URLSearchParams(window.location.search);
        const POST_IDX = urlParams.get('post_idx');

        if (!POST_IDX) {
            contentContainer.innerHTML = '<h1>ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.</h1><a href="/list">ëª©ë¡ìœ¼ë¡œ</a>';
        } else {
            document.getElementById('post_idx_cmt').value = POST_IDX;
            fetchPostDetail();
        }

        let CURRENT_USER_ID = null;
        let POST_AUTHOR_ID = null;

        // ----------------------------------------------------
        // 1. ê²Œì‹œê¸€ ìƒì„¸ ì •ë³´ ì¡°íšŒ ë° UI ì—…ë°ì´íŠ¸
        // ----------------------------------------------------
        async function fetchPostDetail() {
            try {
                // A. ì„¸ì…˜ ì •ë³´ í™•ì¸ (ë¡œê·¸ì¸ ì‚¬ìš©ì ID í™•ì¸)
                const sessionResponse = await fetch('/db/check_session');
                const sessionData = await sessionResponse.json();
                if (sessionData.loggedIn) {
                    CURRENT_USER_ID = sessionData.user.user_id;
                }

                // B. ê²Œì‹œê¸€ ìƒì„¸ ì •ë³´ ìš”ì²­
                const postResponse = await fetch(`/db/post_detail?post_idx=${POST_IDX}`);
                const postData = await postResponse.json();

                if (!postResponse.ok) {
                    alert(postData.error || 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    location.href = '/list';
                    return;
                }

                // C. ë°ì´í„° ë°˜ì˜
                POST_AUTHOR_ID = postData.post.user_id; // ì‘ì„±ì ID ì €ì¥
                
                document.getElementById('post-title').innerText = postData.post.post_title;
                document.getElementById('detail-title').innerText = postData.post.post_title;
                document.getElementById('detail-user').innerText = postData.post.user_id;
                document.getElementById('detail-date').innerText = new Date(postData.post.created_at).toLocaleString();
                document.getElementById('detail-views').innerText = postData.post.post_views;
                document.getElementById('detail-content').innerText = postData.post.post_content;
                
                const fileDiv = document.getElementById('detail-file');
                if (postData.post.post_file) {
                    // ì„œë²„ì˜ /uploads í´ë”ì— ì ‘ê·¼í•˜ë„ë¡ ê²½ë¡œ ì§€ì •
                    fileDiv.innerHTML = `<p>ì²¨ë¶€ íŒŒì¼: <a href="/uploads/${postData.post.post_file}" target="_blank">${postData.post.post_file}</a></p>`;
                } else {
                    fileDiv.innerHTML = `<p>ì²¨ë¶€ íŒŒì¼: ì—†ìŒ</p>`;
                }

                // D. ë²„íŠ¼ ì˜ì—­ ë™ì  ìƒì„± (ìˆ˜ì •/ì‚­ì œ)
                createActionButtons();

                // E. ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
                renderComments(postData.comments);

            } catch (error) {
                console.error("ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:", error);
                alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                location.href = '/list';
            }
        }

        // ----------------------------------------------------
        // 2. ë²„íŠ¼ ë™ì  ìƒì„± ë¡œì§ (ì‘ì„±ìì—ê²Œë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë…¸ì¶œ)
        // ----------------------------------------------------
        function createActionButtons() {
            // ë²„íŠ¼ ì´ˆê¸°í™”
            buttonArea.innerHTML = '';
            
            // ì‘ì„±ìì´ê³  ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
            if (CURRENT_USER_ID && CURRENT_USER_ID === POST_AUTHOR_ID) {
                // ìˆ˜ì • ë²„íŠ¼
                const editBtn = document.createElement('a');
                editBtn.href = `/edit?post_idx=${POST_IDX}`; // /edit í˜ì´ì§€ë¡œ ì´ë™ (ë‚˜ì¤‘ì— êµ¬í˜„)
                editBtn.className = 'button';
                editBtn.style.backgroundColor = '#4CAF50';
                editBtn.innerText = 'ìˆ˜ì •';
                buttonArea.appendChild(editBtn);

                // ì‚­ì œ ë²„íŠ¼
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'button';
                deleteBtn.style.backgroundColor = '#f44336';
                deleteBtn.innerText = 'ì‚­ì œ';
                deleteBtn.onclick = deletePost;
                buttonArea.appendChild(deleteBtn);
            }

            // ëª©ë¡ ë²„íŠ¼ì€ í•­ìƒ ì¶”ê°€
            const listBtn = document.createElement('a');
            listBtn.href = '/list';
            listBtn.className = 'button';
            listBtn.innerText = 'ëª©ë¡ìœ¼ë¡œ';
            buttonArea.appendChild(listBtn);
        }

        // ----------------------------------------------------
        // 3. ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§
        // ----------------------------------------------------
        function renderComments(comments) {
            const commentListDiv = document.getElementById('comment-list');
            commentListDiv.innerHTML = ''; // ì´ˆê¸°í™”

            if (comments.length === 0) {
                commentListDiv.innerHTML = '<p>ì•„ì§ ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            comments.forEach(cmt => {
                const cmtDiv = document.createElement('div');
                cmtDiv.className = 'comment-item';
                // ë‚ ì§œ í¬ë§·íŒ…
                const cmtDate = new Date(cmt.created_at).toLocaleString();
                
                cmtDiv.innerHTML = `
                    <p style="margin: 5px 0;">
                        <strong>${cmt.user_id}</strong> (${cmtDate})
                    </p>
                    <p style="margin: 5px 0 10px 10px;">${cmt.cmt_content}</p>
                    <hr style="border: 0; border-top: 1px solid #eee;">
                `;
                commentListDiv.appendChild(cmtDiv);
            });
        }
        
        // ----------------------------------------------------
        // 4. ê¸€ ì‚­ì œ (DELETE) ê¸°ëŠ¥
        // ----------------------------------------------------
        async function deletePost() {
            if (!confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch('/db/post_delete', {
                    method: 'POST', // DELETE ëŒ€ì‹  POSTë¥¼ ì‚¬ìš©í•˜ê³  bodyì— idxë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ post_idx: POST_IDX })
                });

                const result = await response.json();

                if (response.ok) {
                    alert('ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.href = '/list'; // ì‚­ì œ í›„ ëª©ë¡ìœ¼ë¡œ ì´ë™
                } else {
                    alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error("ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
                alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ----------------------------------------------------
        // 5. ëŒ“ê¸€ ë“±ë¡ í¼ ì œì¶œ ì²˜ë¦¬ (Create)
        // ----------------------------------------------------
        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!CURRENT_USER_ID) {
                alert('ëŒ“ê¸€ ë“±ë¡ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                location.href = '/login';
                return;
            }

            const cmt_content = document.getElementById('cmt_content').value;
            
            const dataToSend = {
                post_idx: POST_IDX,
                cmt_content: cmt_content,
            };

            try {
                // dbRouterì˜ /comment_register ë¡œì§ì€ ì´ë¯¸ ì„¸ì…˜ì—ì„œ user_idë¥¼ ê°€ì ¸ì˜¤ë„ë¡ ìˆ˜ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                const response = await fetch('/db/comment_register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

                if (response.ok) {
                    alert('ëŒ“ê¸€ ë“±ë¡ ì„±ê³µ!');
                    document.getElementById('cmt_content').value = ''; // í¼ ì´ˆê¸°í™”
                    fetchPostDetail(); // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    const result = await response.json();
                    alert(`ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: ${result.error || 'ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.'}`);
                }
                
            } catch (error) {
                console.error("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜:", error);
                alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

    </script>
</body>
</html>

const express = require('express');
const app = express();
const path = require('path');
const session = require('express-session'); // ì„¸ì…˜ ë¯¸ë“¤ì›¨ì–´ í•„ìš”
const PORT = 8000; 

// ----------------------------------------------------
// 1. ëª¨ë“ˆ ë¶ˆëŸ¬ì˜¤ê¸°
// ----------------------------------------------------
// DB ì—°ê²° ì„¤ì • (ì—°ê²° í…ŒìŠ¤íŠ¸ ë¡œì§ì€ db.js íŒŒì¼ì— í¬í•¨)
const db = require("./config/db"); 

// ë¼ìš°í„° ëª¨ë“ˆ ë¶ˆëŸ¬ì˜¤ê¸°
const pageRouter = require('./routes/pageRouter');
const dbRouter = require('./routes/dbRouter'); // ðŸš¨ ë‹¨ìˆœ ê²½ë¡œë¡œ ë³µêµ¬


// ----------------------------------------------------
// 2. ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
// ----------------------------------------------------

// í¼ ë°ì´í„° ì²˜ë¦¬ ë¯¸ë“¤ì›¨ì–´ (JSONì´ ì„¸ì…˜ë³´ë‹¤ ë¨¼ì € ìžˆì–´ì•¼ í•©ë‹ˆë‹¤)
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// ì„¸ì…˜ ì„¤ì • (ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ë¥¼ ìœ„í•´ í•„ìš”)
app.use(session({
    secret: 'my-newton-apple-secret-key',
    resave: false,
    saveUninitialized: false,
    cookie: { 
        maxAge: 60 * 60 * 1000 // 1ì‹œê°„
    }
}));


// ----------------------------------------------------
// 3. ë¼ìš°í„° ì—°ê²° (API ìš”ì²­ì„ ê°€ìž¥ ë¨¼ì € ì²˜ë¦¬í•˜ë„ë¡ ìˆœì„œ ë³€ê²½!)
// ----------------------------------------------------
app.use('/db', dbRouter); // ðŸš¨ /db API ìš”ì²­ì„ ìµœìš°ì„ ìœ¼ë¡œ ì²˜ë¦¬
app.use('/', pageRouter);


// ----------------------------------------------------
// 4. ì •ì  íŒŒì¼ ê²½ë¡œ ì„¤ì • (API ë¼ìš°í„°ë³´ë‹¤ ì•„ëž˜ì— ìœ„ì¹˜)
// ----------------------------------------------------

// public í´ë”ë¥¼ ì •ì  íŒŒì¼ ê²½ë¡œë¡œ ì„¤ì • (HTML, CSS ë“±)
app.use(express.static(path.join(__dirname, 'public')));

// uploads í´ë”ë¥¼ ì •ì  íŒŒì¼ ê²½ë¡œë¡œ ì„¤ì • (ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ì ‘ê·¼)
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));


// ----------------------------------------------------
// 5. ì—ëŸ¬ í•¸ë“¤ë§ ë¯¸ë“¤ì›¨ì–´ (ê°€ìž¥ ë§ˆì§€ë§‰ì— ìœ„ì¹˜)
// ----------------------------------------------------
app.use((err, req, res, next) => {
    console.error(err.stack); 
    res.status(500).send('Server Error: Something went wrong!');
});

// ----------------------------------------------------
// 6. ì„œë²„ ì‹¤í–‰
// ----------------------------------------------------
app.listen(PORT, () => {
    console.log(`Server listening on port ${PORT}`);
});
